{% extends "sns/base.html"%}
{% block content %}

<head>
    <meta charset="utf-8">
    <title>TalkRoom</title>
    
</head>
<h2>{{group_name}}</h2>
<div class="chat-room-body">
{% for message in messages %}
    <div class="chat-box">
        <div class="chat-header">
            名前：{{message.owner.name}}
        </div>
        <div class="chat-body">
            {{message.content}}
        </div>
    </div>
{% endfor %}
<div id="footer"></div>
</div>

<div class="chat-room-footer">
    <div class="send-msg">
        <p id="name">{{request.user.name}}</p>
        <input placeholder="メッセージを入力" id="msg" value=""/><button id="send">送信</button>
    </div>
</div>


<script>
    const url = 'ws://localhost:8000/ws/group/' + '{{room}}'
    var ws = new WebSocket(url)
    
    document.getElementById("send").onclick = function sendMessage () {
        var sendData = {
            name:document.getElementById('name').textContent,
            message: document.getElementById('msg').value
        }
        ws.send(JSON.stringify(sendData))
    }
    
    ws.onmessage = e => {
        var receiveData = JSON.parse(e.data)
        var messageBox = document.createElement('div')
        messageBox.className = 'chat-box'
        var header = '<div class="chat-header">名前：' + receiveData.name + '</div>'
        var body = '<div class="chat-body">' + receiveData.message + '</div>'
        document.getElementById('footer').insertAdjacentHTML('beforebegin', header + body)
        document.getElementById('footer').appendChild(messageBox)
    }
    
    </script>
{% endblock %}